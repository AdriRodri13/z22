{% extends 'panel_admin/base_panel.html' %}
{% load static %}

{% block panel_title %}{{ title }}{% endblock %}

{% block panel_css %}
<link rel="stylesheet" href="{% static 'panel_admin/css/usuarios_descuentos/enviar_codigos.css' %}">
{% endblock %}

{% block content_icon %}<i class="fas fa-paper-plane"></i>{% endblock %}
{% block content_title %}Enviar Códigos de Descuento{% endblock %}

{% block header_actions %}
<a href="{% url 'panel_admin:usuarios_descuentos_dashboard' %}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left"></i>Volver al Dashboard
</a>
{% endblock %}

{% block panel_content %}

<div class="enviar-codigos-section">
    <div class="row">
        <div class="col-lg-8">
            <!-- Opciones de envío -->
            <div class="envio-options-card">
                <div class="form-header">
                    <h4>
                        <i class="fas fa-paper-plane"></i>Opciones de Envío
                    </h4>
                    <p class="text-muted">
                        Selecciona cómo quieres enviar los códigos de descuento
                    </p>
                </div>

                <div class="envio-tabs">
                    <nav class="nav nav-tabs" id="envio-tabs">
                        <button class="nav-link active" id="automatico-tab" data-bs-toggle="tab"
                                data-bs-target="#automatico" type="button">
                            <i class="fas fa-magic"></i>Envío Automático
                        </button>
                        <button class="nav-link" id="manual-tab" data-bs-toggle="tab"
                                data-bs-target="#manual" type="button">
                            <i class="fas fa-hand-paper"></i>Envío Manual
                        </button>
                        <button class="nav-link" id="masivo-tab" data-bs-toggle="tab"
                                data-bs-target="#masivo" type="button">
                            <i class="fas fa-users"></i>Envío Masivo
                        </button>
                    </nav>

                    <div class="tab-content" id="envio-tab-content">
                        <!-- Envío automático -->
                        <div class="tab-pane fade show active" id="automatico">
                            <div class="tab-content-wrapper">
                                <div class="option-header">
                                    <h5>Envío Automático Basado en Configuración</h5>
                                    <p class="text-muted">
                                        Envía códigos a usuarios que cumplan los criterios de inactividad configurados
                                    </p>
                                </div>

                                <div class="current-config-info">
                                    {% if config_activa %}
                                        <div class="config-badge bg-success">
                                            <i class="fas fa-check-circle"></i>
                                            Sistema activo: {{ config_activa.dias_inactividad }} días • {{ config_activa.porcentaje_descuento }}%
                                        </div>
                                    {% else %}
                                        <div class="config-badge bg-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            No hay configuración activa
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="envio-actions">
                                    {% if config_activa %}
                                        <button type="button" class="btn btn-primary btn-lg" onclick="envioAutomatico(false)">
                                            <i class="fas fa-paper-plane"></i>Enviar Códigos Automáticos
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-lg" onclick="previewAutomatico()">
                                            <i class="fas fa-eye"></i>Vista Previa (Dry Run)
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn btn-outline-secondary btn-lg" disabled>
                                            <i class="fas fa-exclamation-triangle"></i>Configuración Requerida
                                        </button>
                                        <a href="{% url 'panel_admin:configuracion_descuentos' %}" class="btn btn-primary btn-lg">
                                            <i class="fas fa-cog"></i>Ir a Configuración
                                        </a>
                                    {% endif %}
                                </div>

                                <div class="help-text">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i>
                                        Solo se enviarán códigos a usuarios con carrito inactivo según la configuración.
                                        Los usuarios que ya recibieron códigos no recibirán duplicados.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Envío manual -->
                        <div class="tab-pane fade" id="manual">
                            <div class="tab-content-wrapper">
                                <div class="option-header">
                                    <h5>Envío Manual a Usuarios Específicos</h5>
                                    <p class="text-muted">
                                        Selecciona usuarios específicos para enviarles códigos personalizados
                                    </p>
                                </div>

                                <form id="envio-manual-form">
                                    <div class="form-group mb-4">
                                        <label for="usuarios-select" class="form-label">
                                            <i class="fas fa-users"></i>Seleccionar Usuarios
                                            <span class="text-muted">({{ usuarios_con_carrito.count }} disponibles)</span>
                                        </label>
                                        <select class="form-select" id="usuarios-select" multiple size="8">
                                            {% for usuario in usuarios_con_carrito %}
                                                <option value="{{ usuario.id }}"
                                                        data-instagram="@{{ usuario.profile.instagram_account }}"
                                                        data-email="{{ usuario.email }}"
                                                        data-items="{{ usuario.items_carrito }}">
                                                    @{{ usuario.profile.instagram_account }} - {{ usuario.email }}
                                                    ({{ usuario.items_carrito }} items en carrito)
                                                </option>
                                            {% empty %}
                                                <option disabled>No hay usuarios con carrito actualmente</option>
                                            {% endfor %}
                                        </select>
                                        <div class="form-text">
                                            <i class="fas fa-mouse-pointer"></i>
                                            Mantén <kbd>Ctrl</kbd> presionado para seleccionar múltiples usuarios
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <label for="porcentaje-manual" class="form-label">Porcentaje de Descuento</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="porcentaje-manual"
                                                       min="1" max="100" value="{{ config_activa.porcentaje_descuento|default:'10' }}">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="expiracion-manual" class="form-label">Días hasta Expiración</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="expiracion-manual"
                                                       min="1" max="365" value="30" placeholder="30">
                                                <span class="input-group-text">días</span>
                                            </div>
                                            <div class="form-text">Dejar vacío para códigos sin expiración</div>
                                        </div>
                                    </div>

                                    <div class="selected-users-preview" id="selected-users-preview" style="display: none;">
                                        <h6>Usuarios Seleccionados:</h6>
                                        <div id="selected-users-list"></div>
                                    </div>

                                    <div class="envio-actions">
                                        <button type="button" class="btn btn-success btn-lg" onclick="envioManual()">
                                            <i class="fas fa-paper-plane"></i>Enviar a Seleccionados
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-lg" onclick="seleccionarTodos()">
                                            <i class="fas fa-check-square"></i>Seleccionar Todos
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-lg" onclick="limpiarSeleccion()">
                                            <i class="fas fa-times"></i>Limpiar Selección
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Envío masivo -->
                        <div class="tab-pane fade" id="masivo">
                            <div class="tab-content-wrapper">
                                <div class="option-header">
                                    <h5>Envío Masivo a Todos los Usuarios</h5>
                                    <p class="text-muted">
                                        Envía códigos promocionales a todos los usuarios con carrito, independientemente de su actividad
                                    </p>
                                </div>

                                <div class="warning-box">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>¡Atención!</strong> Esta acción enviará códigos a todos los usuarios con items en carrito,
                                        incluso si ya tienen códigos activos o han estado activos recientemente.
                                    </div>
                                </div>

                                <form id="envio-masivo-form">
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-4">
                                            <label for="porcentaje-masivo" class="form-label">Porcentaje de Descuento</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="porcentaje-masivo"
                                                       min="1" max="100" value="15">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <label for="expiracion-masivo" class="form-label">Días hasta Expiración</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="expiracion-masivo"
                                                       min="1" max="365" value="7">
                                                <span class="input-group-text">días</span>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label">Usuarios Objetivo</label>
                                            <div class="objetivo-count">
                                                <span class="count-number">{{ usuarios_con_carrito.count }}</span>
                                                <span class="count-label">usuarios con carrito</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-check mb-4">
                                        <input class="form-check-input" type="checkbox" id="confirmar-masivo">
                                        <label class="form-check-label" for="confirmar-masivo">
                                            <strong>Confirmo que quiero enviar códigos masivamente a todos los usuarios</strong>
                                        </label>
                                    </div>

                                    <div class="envio-actions">
                                        <button type="button" class="btn btn-danger btn-lg" onclick="envioMasivo()" id="btn-envio-masivo" disabled>
                                            <i class="fas fa-broadcast-tower"></i>Envío Masivo
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-lg" onclick="previewMasivo()">
                                            <i class="fas fa-eye"></i>Vista Previa Masiva
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resultados del envío -->
            <div class="resultados-envio" id="resultados-envio" style="display: none;">
                <div class="resultados-card">
                    <div class="resultados-header">
                        <h5><i class="fas fa-chart-bar"></i>Resultados del Envío</h5>
                    </div>
                    <div class="resultados-body" id="resultados-body">
                        <!-- Los resultados se llenarán con JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de información -->
        <div class="col-lg-4">
            <div class="info-panel">
                <!-- Estado del sistema -->
                <div class="info-card">
                    <div class="info-header">
                        <h5><i class="fas fa-cog"></i>Estado del Sistema</h5>
                    </div>
                    <div class="info-body">
                        {% if config_activa %}
                            <div class="system-status active">
                                <i class="fas fa-check-circle"></i>
                                <span>Sistema Activo</span>
                            </div>
                            <div class="config-details">
                                <p><strong>{{ config_activa.dias_inactividad }}</strong> días de inactividad</p>
                                <p><strong>{{ config_activa.porcentaje_descuento }}%</strong> de descuento</p>
                            </div>
                        {% else %}
                            <div class="system-status inactive">
                                <i class="fas fa-times-circle"></i>
                                <span>Sistema Inactivo</span>
                            </div>
                            <p class="text-muted">
                                <a href="{% url 'panel_admin:usuarios_configuracion' %}">Configura el sistema</a>
                                para habilitar envíos automáticos.
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Estadísticas de envío -->
                <div class="info-card">
                    <div class="info-header">
                        <h5><i class="fas fa-chart-pie"></i>Estadísticas</h5>
                    </div>
                    <div class="info-body">
                        <div class="stat-row">
                            <div class="stat-item">
                                <div class="stat-number text-primary">{{ usuarios_con_carrito.count }}</div>
                                <div class="stat-label">Con carrito</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number text-success">{{ codigos_activos }}</div>
                                <div class="stat-label">Códigos activos</div>
                            </div>
                        </div>
                        <div class="stat-row">
                            <div class="stat-item">
                                <div class="stat-number text-warning">{{ usuarios_inactivos }}</div>
                                <div class="stat-label">Usuarios inactivos</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number text-info">{{ emails_enviados_hoy }}</div>
                                <div class="stat-label">Emails hoy</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actividad reciente -->
                <div class="info-card">
                    <div class="info-header">
                        <h5><i class="fas fa-clock"></i>Actividad Reciente</h5>
                    </div>
                    <div class="info-body">
                        {% if ultimos_envios %}
                            {% for envio in ultimos_envios %}
                                <div class="activity-item">
                                    <div class="activity-icon">
                                        <i class="fas fa-paper-plane"></i>
                                    </div>
                                    <div class="activity-info">
                                        <div class="activity-text">
                                            Código enviado a @{{ envio.user.profile.instagram_account }}
                                        </div>
                                        <div class="activity-time">
                                            {{ envio.fecha_creacion|timesince }} ago
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">No hay actividad reciente</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block panel_js %}
<script>
// Control del checkbox para envío masivo
document.getElementById('confirmar-masivo').addEventListener('change', function() {
    document.getElementById('btn-envio-masivo').disabled = !this.checked;
});

// Control de selección múltiple de usuarios
document.getElementById('usuarios-select').addEventListener('change', function() {
    const selected = Array.from(this.selectedOptions);
    const preview = document.getElementById('selected-users-preview');
    const list = document.getElementById('selected-users-list');

    if (selected.length > 0) {
        list.innerHTML = selected.map(option =>
            `<span class="badge bg-primary me-2 mb-1">
                ${option.dataset.instagram} (${option.dataset.items} items)
            </span>`
        ).join('');
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
});

function seleccionarTodos() {
    const select = document.getElementById('usuarios-select');
    for (let option of select.options) {
        option.selected = true;
    }
    select.dispatchEvent(new Event('change'));
}

function limpiarSeleccion() {
    const select = document.getElementById('usuarios-select');
    for (let option of select.options) {
        option.selected = false;
    }
    select.dispatchEvent(new Event('change'));
}

function envioAutomatico(isDryRun = false) {
    const action = isDryRun ? 'Vista previa' : 'Enviando';
    mostrarResultados(`${action} del envío automático...`, 'loading');

    fetch('{% url "panel_admin:usuarios_enviar_codigos" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            tipo: 'automatico',
            dry_run: isDryRun
        })
    })
    .then(response => response.json())
    .then(data => {
        mostrarResultadosEnvio(data);
    })
    .catch(error => {
        mostrarResultados('Error en el envío automático', 'error');
    });
}

function previewAutomatico() {
    envioAutomatico(true);
}

function envioManual() {
    const selected = Array.from(document.getElementById('usuarios-select').selectedOptions);
    if (selected.length === 0) {
        alert('Selecciona al menos un usuario');
        return;
    }

    const userIds = selected.map(option => option.value);
    const porcentaje = document.getElementById('porcentaje-manual').value;
    const expiracion = document.getElementById('expiracion-manual').value;

    mostrarResultados('Enviando códigos a usuarios seleccionados...', 'loading');

    fetch('{% url "panel_admin:usuarios_enviar_codigos" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            tipo: 'manual',
            user_ids: userIds,
            porcentaje: porcentaje,
            dias_expiracion: expiracion
        })
    })
    .then(response => response.json())
    .then(data => {
        mostrarResultadosEnvio(data);
    })
    .catch(error => {
        mostrarResultados('Error en el envío manual', 'error');
    });
}

function envioMasivo() {
    if (!document.getElementById('confirmar-masivo').checked) {
        alert('Debes confirmar el envío masivo');
        return;
    }

    const porcentaje = document.getElementById('porcentaje-masivo').value;
    const expiracion = document.getElementById('expiracion-masivo').value;

    if (!confirm('¿Estás seguro de enviar códigos a TODOS los usuarios con carrito?')) {
        return;
    }

    mostrarResultados('Enviando códigos masivamente...', 'loading');

    fetch('{% url "panel_admin:usuarios_enviar_codigos" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            tipo: 'masivo',
            porcentaje: porcentaje,
            dias_expiracion: expiracion
        })
    })
    .then(response => response.json())
    .then(data => {
        mostrarResultadosEnvio(data);
    })
    .catch(error => {
        mostrarResultados('Error en el envío masivo', 'error');
    });
}

function previewMasivo() {
    mostrarResultados('Generando vista previa masiva...', 'loading');

    fetch('{% url "panel_admin:usuarios_enviar_codigos" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            tipo: 'masivo',
            dry_run: true,
            porcentaje: document.getElementById('porcentaje-masivo').value,
            dias_expiracion: document.getElementById('expiracion-masivo').value
        })
    })
    .then(response => response.json())
    .then(data => {
        mostrarResultadosEnvio(data);
    })
    .catch(error => {
        mostrarResultados('Error en la vista previa', 'error');
    });
}

function mostrarResultados(mensaje, tipo) {
    const resultadosDiv = document.getElementById('resultados-envio');
    const bodyDiv = document.getElementById('resultados-body');

    let icon = 'fas fa-spinner fa-spin';
    let className = 'alert-info';

    if (tipo === 'error') {
        icon = 'fas fa-exclamation-triangle';
        className = 'alert-danger';
    } else if (tipo === 'success') {
        icon = 'fas fa-check-circle';
        className = 'alert-success';
    }

    bodyDiv.innerHTML = `
        <div class="alert ${className}">
            <i class="${icon}"></i> ${mensaje}
        </div>
    `;

    resultadosDiv.style.display = 'block';
    resultadosDiv.scrollIntoView({ behavior: 'smooth' });
}

function mostrarResultadosEnvio(data) {
    const bodyDiv = document.getElementById('resultados-body');

    if (data.success) {
        let html = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                ${data.dry_run ? 'Vista previa completada' : 'Envío completado exitosamente'}
            </div>

            <div class="results-stats">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="result-stat">
                            <div class="stat-number text-success">${data.enviados}</div>
                            <div class="stat-label">${data.dry_run ? 'Se enviarían' : 'Enviados'}</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="result-stat">
                            <div class="stat-number text-warning">${data.omitidos}</div>
                            <div class="stat-label">Omitidos</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="result-stat">
                            <div class="stat-number text-danger">${data.errores}</div>
                            <div class="stat-label">Errores</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="result-stat">
                            <div class="stat-number text-info">${data.total}</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        if (data.detalles && data.detalles.length > 0) {
            html += '<div class="results-details"><h6>Detalles:</h6><ul>';
            data.detalles.forEach(detalle => {
                html += `<li>${detalle}</li>`;
            });
            html += '</ul></div>';
        }

        bodyDiv.innerHTML = html;
    } else {
        bodyDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Error: ${data.error || 'Error desconocido'}
            </div>
        `;
    }
}
</script>
{% endblock %}